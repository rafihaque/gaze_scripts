#!/bin/sh
#SBATCH --mem=3g
#SBATCH --cpus-per-task=4
#SBATCH --error=/data/haqueru/gaze/preprocess.log
#SBATCH --output=/data/haqueru/gaze/preproccess.log
#SBATCH --time=04:00:00
#SBATCH --gres=lscratch:1

# FaceFrames-0b7da7a0e3a239b0ff8509c02d64b640fda327b8c156e497698d382c8464310a

# define variables
root_dir=$1 
subj=$2
tool_dir=$3

# define directories
subj_zip="$root_dir""_raw/""$subj"".tar.gz"
subj_dir="$root_dir/""$subj"
frames_dir="$subj_dir/""frames"
face_dir="$subj_dir""/appleFace"
face_file="$subj_dir/""appleFace.json"

# unzip subject and frames_dir within subject
if [ ! -e "$subj_dir" ]; then 
    #unzip -o "$subj_zip" -d "$root_dir"
    tar xvzf "$subj_zip" -C "$root_dir"
fi
if [ ! -e "$frames_dir" ]; then 
    unzip -o "$frames_dir"".zip" -d "$subj_dir"
fi

# detect faces and eyes using openCV
if [ ! -f "$face_file" ]; then
    "$tool_dir"exec_DetectFacePython.sh "$subj_dir" "$tool_dir"
fi

# create image crops of face and eyes
if [ ! -f "$face_dir" ]; then
    "$tool_dir"run_generateCrops.sh /usr/local/matlab-compiler/v94 "$subj_dir"
    #"$tool_dir"run_generateFaceGridsFromFaceRect_Al.sh /usr/local/matlab-compiler/v94 "$subj_dir"
fi

#




# #Unzip frames_dir.zip if xyTorch_MIT_ipad_scratch.mat does not exist
# filePath="$rawDataPath""$subject""/xyTorch_MIT_ipad_scratch.mat"
# zipPath2="$rawDataPath/""$subject""/frames_dir.zip"
#   if [ ! -e "$filePath" ]; then #e is for existence, which will recognize matlab file
#    echo check if exists "$filePath"
#    # unzip -o "$zipPath2" -d "${zipPath2%frames_dir.zip}"
#    # sleep 6m
#   fi

# #Detect Faces and Eyes using OpenCV
# filePath="$rawDataPath""/$subject""/appleFace.json"
#   if [ ! -f "$filePath" ]; then
#    echo"Detecting Face and Eyes $filePath"
#     "$workDir2"exec_DetectFacePython.sh "$subject" "$workDir2" "$whichDir" "$rawDataPath"
#   fi

# #Create image crops of face and eyes. Also extract grid.mat
# filePath="$rawDataPath""/$subject""/appleFace"
#   if [ ! -d "$filePath" ]; then
#     #echo "Extracting ROIs"
#     #Generate Crops
#     "$workDir"run_generateCrops.sh /opt/matlab/MCR/2017b/ "$rawDataPath""/$subject"
#     #Generate Grids
#     "$workDir"run_generateFaceGridsFromFaceRect_Al.sh /opt/matlab/MCR/2017b/ "$rawDataPath""/$subject"
#   fi
# }
